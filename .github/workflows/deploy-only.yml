name: Deploy Only (Skip Tests)

on:
  workflow_dispatch:  # Manual trigger
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/deploy-only.yml'

env:
  PROJECT_ID: cloud-run-project-477318
  REGION: us-central1

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/1074963275925/locations/global/workloadIdentityPools/github-random-medscript/providers/github'
          service_account: 'github-wif@cloud-run-project-477318.iam.gserviceaccount.com'
          project_id: cloud-run-project-477318

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Ensure Artifact Registry repository exists
        run: |
          gcloud artifacts repositories create medscript-ai-backend \
            --repository-format=docker \
            --location=us-central1 \
            --project=cloud-run-project-477318 \
            --description="Docker repository for MedScript AI Backend" 2>/dev/null || echo "Repository already exists"

      - name: Build and deploy backend
        timeout-minutes: 45
        run: |
          cd backend
          IMAGE_NAME="us-central1-docker.pkg.dev/cloud-run-project-477318/medscript-ai-backend/medscript-ai-backend"
          IMAGE_TAG="${{ github.sha }}"
          
          echo "ðŸš€ Building backend Docker image..."
          echo "This may take 10-20 minutes due to large ML dependencies..."
          
          # Build with timeout and optimized settings
          gcloud builds submit . \
            --tag "$IMAGE_NAME:$IMAGE_TAG" \
            --project=$PROJECT_ID \
            --timeout=40m \
            || (echo "Build failed, checking logs..." && exit 1)
          
          echo "âœ… Build completed successfully!"

          echo "ðŸš€ Deploying backend to Cloud Run..."
          gcloud run deploy medscript-ai-backend \
            --image "$IMAGE_NAME:$IMAGE_TAG" \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --memory=2Gi \
            --cpu=2 \
            --set-env-vars="DOCUMENT_UPLOAD_BUCKET=medscript-uploads" \
            --timeout=300 \
            --max-instances=10 \
            --min-instances=0 \
            --concurrency=80 \
            --project=$PROJECT_ID || exit 1

          BACKEND_URL=$(gcloud run services describe medscript-ai-backend \
            --region $REGION \
            --format 'value(status.url)' \
            --project=$PROJECT_ID)
          
          echo "Backend URL: $BACKEND_URL"
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT

    outputs:
      backend-url: ${{ steps.deploy.outputs.url || 'https://medscript-ai-backend-1074963275925.us-central1.run.app' }}


  deploy-frontend:
    needs: deploy-backend
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/1074963275925/locations/global/workloadIdentityPools/github-random-medscript/providers/github'
          service_account: 'github-wif@cloud-run-project-477318.iam.gserviceaccount.com'
          project_id: cloud-run-project-477318

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Ensure Artifact Registry repository exists
        run: |
          gcloud artifacts repositories create medscript-ai-frontend \
            --repository-format=docker \
            --location=us-central1 \
            --project=cloud-run-project-477318 \
            --description="Docker repository for MedScript AI Frontend" 2>/dev/null || echo "Repository already exists"

      - name: Wait to avoid Cloud Build rate limits
        run: |
          echo "â³ Waiting 60 seconds to avoid Cloud Build API quota exhaustion..."
          sleep 60

      - name: Build and deploy frontend
        id: deploy
        run: |
          cd frontend
          BACKEND_URL="https://medscript-ai-backend-1074963275925.us-central1.run.app/api/v1"
          IMAGE_NAME="us-central1-docker.pkg.dev/cloud-run-project-477318/medscript-ai-frontend/medscript-ai-frontend"
          IMAGE_TAG="${{ github.sha }}"
          echo "ðŸš€ Building frontend with backend URL: $BACKEND_URL"
          
          gcloud builds submit . \
            --config cloudbuild.yaml \
            --substitutions _REACT_APP_API_BASE_URL="$BACKEND_URL",_IMAGE_NAME="$IMAGE_NAME",_IMAGE_TAG="$IMAGE_TAG" \
            --project=$PROJECT_ID || exit 1

          echo "ðŸš€ Deploying frontend to Cloud Run..."
          gcloud run deploy medscript-ai-frontend \
            --image "$IMAGE_NAME:$IMAGE_TAG" \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --timeout=60 \
            --max-instances=10 \
            --min-instances=0 \
            --concurrency=80 \
            --project=$PROJECT_ID || exit 1

          FRONTEND_URL=$(gcloud run services describe medscript-ai-frontend \
            --region $REGION \
            --format 'value(status.url)' \
            --project=$PROJECT_ID)
          echo "url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "Frontend URL: $FRONTEND_URL"

      - name: Show deployment URLs
        run: |
          echo "=== âœ… Deployment Complete ==="
          echo "Backend: https://medscript-ai-backend-1074963275925.us-central1.run.app"
          echo "Frontend: ${{ steps.deploy.outputs.url }}"
          echo ""
          echo "ðŸŽ‰ Both backend and frontend deployed successfully!"
